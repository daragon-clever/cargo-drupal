<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\offres_emploi\OffreEmploiRepository;
use Symfony\Component\Process\Process;


function offres_emploi_theme($existing, $type, $theme, $path) {
    return [
        'offres_emploi--list' => [
            'variables' => [
                'data' => 'NULL',
                'filter' => NULL
            ]
        ],
        'offres_emploi--annonce' => [
            'variables' => [
                'data' => NULL,
            ]
        ],
        'offres_emploi--form-postuler' => [
            'variables' => [
                'data' => NULL,
                'form' => NULL
            ]
        ]
    ];
}



function offres_emploi_cron()
{
    \Drupal::logger('offres_emploi')->notice('[OFFRES EMPLOI] Lancement cron');

    $url = \Drupal::request()->getHost();
    $path = dirname(DRUPAL_ROOT);

    $process = new Process( 'php ' . $path . '/vendor/bin/drupal --uri='. $url . ' offres_emploi:import');
    $process->run();

    drupal_flush_all_caches();

    if (!$process->isSuccessful()) {
        \Drupal::logger('offres_emploi')->error('Erreur dans l import des offres => drupal command failed');
    }

    // Update last run.
    \Drupal::state()->set('offres_emploi.last_run', REQUEST_TIME);

    \Drupal::logger('offres_emploi')->notice('[OFFRES EMPLOI] Cron terminÃ©');

}

function offres_emploi_webform_element_hidden_alter(array &$element, FormStateInterface $form_state, array $context)
{
    $route_match = \Drupal::service('current_route_match');
    $param_ref = $route_match->getParameter('ref');

    $connection = \Drupal::service('database');
    $offreRepository = new OffreEmploiRepository($connection);

    if ($element['#webform_key'] == 'offre') {
        $element['#value'] = $param_ref;
    }
    $offerEmploi = $offreRepository->findBy(['codeRecrutement' => $param_ref]);
    if ($element['#webform_key'] == 'nom_offre') {
        $element['#value'] = $offerEmploi["intitulePoste"];
    }
    if ($element['#webform_key'] == 'filiale_societe') {
        $element['#value'] = $offerEmploi["filialeSociete"];
    }
}
